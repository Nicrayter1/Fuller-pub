<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∏ Bar Stock System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        /* –õ–û–ì–û–¢–ò–ü */
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 24px;
            color: #1d1d1f;
            margin-bottom: 5px;
        }
        
        .logo p {
            color: #86868b;
            font-size: 14px;
        }
        
        /* –§–û–†–ú–´ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056cc;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        /* –°–¢–ê–¢–£–° */
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }
        
        /* –¢–ê–ë–õ–ò–¶–ê */
        .table-container {
            display: none;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .category-header {
            background: #e8f4ff;
            font-weight: 600;
            color: #007aff;
        }
        
        .stock-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        .stock-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav-bar {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: #007aff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* –ü–û–ò–°–ö */
        .search-box {
            margin: 15px 0;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        .admin-controls {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 13px;
            }
            
            .stock-input {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† -->
    <div class="container" id="appContainer">
        <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
        <div id="loginScreen">
            <div class="logo">
                <h1>üç∏ Bar Stock</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Å—Ç–æ–∫–æ–≤ –±–∞—Ä–∞</p>
            </div>
            
            <div class="status" id="loginStatus"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email" required 
                           placeholder="user@bar.com">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-control" id="password" required 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
            </form>
        </div>
        
        <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
        <div id="mainScreen" style="display: none;">
            <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
            <div class="nav-bar">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName"></div>
                        <div style="font-size: 12px; color: #666;" id="userRole"></div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 16px;">
                    –í—ã–π—Ç–∏
                </button>
            </div>
            
            <!-- –°–¢–ê–¢–£–° -->
            <div class="status" id="mainStatus"></div>
            
            <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø –ê–î–ú–ò–ù–ê -->
            <div class="admin-controls" id="adminControls">
                <button class="btn btn-success" onclick="openAddModal('category')">
                    + –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                </button>
                <button class="btn btn-success" onclick="openAddModal('product')">
                    + –ü—Ä–æ–¥—É–∫—Ç
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç
                </button>
            </div>
            
            <!-- –ü–û–ò–°–ö -->
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="filterProducts()">
            </div>
            
            <!-- –¢–ê–ë–õ–ò–¶–ê -->
            <div class="table-container" id="tableContainer">
                <div class="loader" id="tableLoader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th>–û–±—ä–µ–º</th>
                            <th>–ë–∞—Ä 1</th>
                            <th>–ë–∞—Ä 2</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –í–í–û–î–ê -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-title" id="stockModalTitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <input type="number" step="0.1" class="form-control" id="stockInput" 
                   placeholder="0.0" autofocus>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeStockModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button class="btn btn-primary" onclick="saveStock()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-title" id="addModalTitle"></div>
            <div id="addModalContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ù–ê–ß–ï–ù–ò–Ø!
        const SUPABASE_URL = 'https://–í–ê–®_ID.supabase.co';
        const SUPABASE_KEY = '–í–ê–®_ANON_KEY';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = null;
        let currentRole = null;
        let currentBar = 1;
        let products = [];
        let categories = [];
        let currentEdit = null;
        
        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session && session.user) {
                await loadUserProfile(session.user.id);
                showMainScreen();
            }
        }
        
        // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('loginStatus');
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = '–í—Ö–æ–¥...';
            status.className = 'status info';
            status.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            status.style.display = 'block';
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email.trim(),
                    password: password
                });
                
                if (error) throw error;
                
                await loadUserProfile(data.user.id);
                showMainScreen();
                
                status.className = 'status success';
                status.textContent = '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!';
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserProfile(userId) {
            const { data: profile, error } = await supabase
                .from('user_profiles')
                .select(`
                    *,
                    user_roles (name)
                `)
                .eq('id', userId)
                .single();
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                await createDefaultProfile(userId);
                return await loadUserProfile(userId);
            }
            
            currentUser = profile;
            currentRole = profile.user_roles.name;
            currentBar = profile.bar_number || 1;
            
            updateUserUI();
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        async function createDefaultProfile(userId) {
            const { data: user, error: userError } = await supabase.auth.getUser();
            
            if (userError) throw userError;
            
            const { error } = await supabase
                .from('user_profiles')
                .insert([{
                    id: userId,
                    email: user.user.email,
                    full_name: user.user.email.split('@')[0],
                    role_id: 2, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞—Ä–º–µ–Ω
                    bar_number: 1,
                    is_active: true
                }]);
            
            if (error) throw error;
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentRole = null;
            showLoginScreen();
        }
        
        // ==================== –ò–ù–¢–ï–†–§–ï–ô–° ====================
        
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginStatus').style.display = 'none';
        }
        
        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞
            if (currentRole === 'admin') {
                document.getElementById('adminControls').style.display = 'flex';
            } else {
                document.getElementById('adminControls').style.display = 'none';
            }
            
            loadData();
        }
        
        function updateUserUI() {
            document.getElementById('userName').textContent = currentUser.full_name || currentUser.email;
            document.getElementById('userRole').textContent = currentRole === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ë–∞—Ä–º–µ–Ω';
            
            const firstLetter = (currentUser.full_name || currentUser.email).charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = firstLetter;
        }
        
        // ==================== –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò ====================
        
        async function loadData() {
            showLoader(true);
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const { data: cats, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('order_index');
                
                if (catError) throw catError;
                categories = cats;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: prods, error: prodError } = await supabase
                    .from('products')
                    .select('*')
                    .order('category_id')
                    .order('name');
                
                if (prodError) throw prodError;
                products = prods;
                
                updateTable();
                
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.category_id]) grouped[p.category_id] = [];
                grouped[p.category_id].push(p);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const sortedCats = [...categories].sort((a, b) => a.order_index - b.order_index);
            
            sortedCats.forEach(cat => {
                const catProducts = grouped[cat.id] || [];
                
                if (catProducts.length > 0) {
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const catRow = document.createElement('tr');
                    catRow.className = 'category-header';
                    catRow.innerHTML = `<td colspan="4">${cat.name}</td>`;
                    tbody.appendChild(catRow);
                    
                    // –ü—Ä–æ–¥—É–∫—Ç—ã
                    catProducts.forEach(product => {
                        const row = document.createElement('tr');
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã
                        const canEditBar1 = currentRole === 'admin' || (currentRole === 'barman' && currentBar === 1);
                        const canEditBar2 = currentRole === 'admin' || (currentRole === 'barman' && currentBar === 2);
                        
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.volume} –º–ª</td>
                            <td>
                                <input type="number" step="0.1" 
                                       class="stock-input" 
                                       value="${product.bar1 || 0}"
                                       ${canEditBar1 ? '' : 'disabled'}
                                       onchange="updateStock(${product.id}, 'bar1', this.value)">
                            </td>
                            <td>
                                <input type="number" step="0.1"
                                       class="stock-input"
                                       value="${product.bar2 || 0}"
                                       ${canEditBar2 ? '' : 'disabled'}
                                       onchange="updateStock(${product.id}, 'bar2', this.value)">
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            });
        }
        
        async function updateStock(productId, field, value) {
            try {
                const { error } = await supabase
                    .from('products')
                    .update({ [field]: parseFloat(value) || 0 })
                    .eq('id', productId);
                
                if (error) throw error;
                
                showStatus('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                loadData();
            }
        }
        
        // ==================== –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ò ====================
        
        function openAddModal(type) {
            if (currentRole !== 'admin') return;
            
            const modal = document.getElementById('addModal');
            const title = document.getElementById('addModalTitle');
            const content = document.getElementById('addModalContent');
            
            if (type === 'category') {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                content.innerHTML = `
                    <input type="text" class="form-control" id="catName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                    <input type="number" class="form-control" style="margin-top: 10px;" 
                           id="catOrder" placeholder="–ü–æ—Ä—è–¥–æ–∫ (0,1,2...)" value="0">
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
            } else {
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
                
                let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                categories.forEach(cat => {
                    options += `<option value="${cat.id}">${cat.name}</option>`;
                });
                
                content.innerHTML = `
                    <select class="form-control" id="prodCategory">
                        ${options}
                    </select>
                    <input type="text" class="form-control" style="margin-top: 10px;" 
                           id="prodName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞">
                    <input type="number" class="form-control" style="margin-top: 10px;" 
                           id="prodVolume" placeholder="–û–±—ä–µ–º –≤ –º–ª">
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }
        
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        async function addCategory() {
            const name = document.getElementById('catName').value.trim();
            const order = document.getElementById('catOrder').value;
            
            if (!name) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .insert([{ name, order_index: parseInt(order) || 0 }]);
                
                if (error) throw error;
                
                showStatus('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                closeAddModal();
                loadData();
                
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function addProduct() {
            const categoryId = document.getElementById('prodCategory').value;
            const name = document.getElementById('prodName').value.trim();
            const volume = document.getElementById('prodVolume').value;
            
            if (!categoryId || !name || !volume) {
                showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .insert([{
                        category_id: parseInt(categoryId),
                        name: name,
                        volume: parseInt(volume),
                        bar1: 0,
                        bar2: 0
                    }]);
                
                if (error) throw error;
                
                showStatus('–ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                closeAddModal();
                loadData();
                
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function showStatus(message, type) {
            const status = document.getElementById('mainStatus');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function showLoader(show) {
            document.getElementById('tableLoader').style.display = show ? 'block' : 'none';
        }
        
        function filterProducts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        async function exportData() {
            let csv = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–û–±—ä–µ–º;–ë–∞—Ä 1;–ë–∞—Ä 2\n';
            
            products.forEach(product => {
                const category = categories.find(c => c.id === product.category_id);
                csv += `${category?.name || ''};${product.name};${product.volume};${product.bar1 || 0};${product.bar2 || 0}\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `—Å—Ç–æ–∫–∏_–±–∞—Ä–∞_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            setInterval(() => {
                if (currentUser) loadData();
            }, 300000);
        });
    </script>
</body>
</html>
