<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∏ Fuller Pub - –£—á–µ—Ç —Å—Ç–æ–∫–æ–≤</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç∏</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --light: #F8F9FA;
            --dark: #343A40;
            --gray: #6C757D;
            --border: #DEE2E6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* –•–ï–î–ï–† */
        .app-header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-title h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ */
        .main-content {
            padding: 30px;
        }
        
        /* –ö–ê–†–¢–û–ß–ö–ê –í–•–û–î–ê */
        .login-card {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            text-align: center;
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        /* –§–û–†–ú–´ */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,122,255,0.3);
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        /* –°–¢–ê–¢–£–° */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
            display: block;
        }
        
        .alert-error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
            display: block;
        }
        
        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
            display: block;
        }
        
        /* –ö–û–ù–¢–†–û–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ */
        .control-panel {
            display: none;
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* –ü–û–ò–°–ö */
        .search-box {
            margin: 20px 0;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236C757D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E") no-repeat right 20px center;
        }
        
        /* –¢–ê–ë–õ–ò–¶–ê */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: var(--light);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .category-row {
            background: #E8F4FF !important;
            font-weight: 600;
        }
        
        .category-row td {
            padding: 20px 16px;
            color: var(--primary);
            font-size: 16px;
        }
        
        /* –ò–ù–ü–£–¢–´ –í –¢–ê–ë–õ–ò–¶–ï */
        .stock-input {
            width: 90px;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .stock-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        
        .stock-input:disabled {
            background: #F8F9FA;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .control-panel {
                justify-content: center;
            }
            
            .btn {
                padding: 12px 20px;
            }
            
            th, td {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .stock-input {
                width: 80px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .login-card {
                padding: 30px 20px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
            
            .container {
                background: #1e1e1e;
                color: #ffffff;
            }
            
            .form-control, .search-box input {
                background: #2d2d2d;
                border-color: #404040;
                color: #ffffff;
            }
            
            .alert-success {
                background: #0f5132;
                color: #d1e7dd;
            }
            
            .alert-error {
                background: #842029;
                color: #f8d7da;
            }
            
            .category-row {
                background: #2c5282 !important;
            }
            
            .modal-content {
                background: #2d2d2d;
                color: #ffffff;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–ê–ü–ö–ê (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
        <div class="app-header" id="appHeader" style="display: none;">
            <div class="app-title">
                <span style="font-size: 28px;">üç∏</span>
                <h1>Fuller Pub - –£—á–µ—Ç —Å—Ç–æ–∫–æ–≤</h1>
            </div>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div style="font-size: 12px; opacity: 0.8;" id="userRole">–ë–∞—Ä–º–µ–Ω</div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="logout()" style="margin-left: 15px;">
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ï –°–û–î–ï–†–ñ–ò–ú–û–ï -->
        <div class="main-content">
            <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
            <div id="loginScreen">
                <div class="login-card">
                    <div class="login-logo">üç∏</div>
                    <h1 class="login-title">Fuller Pub</h1>
                    <p class="login-subtitle">–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö —Å—Ç–æ–∫–æ–≤</p>
                    
                    <div class="alert" id="loginAlert"></div>
                    
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" class="form-control" id="email" required
                                   placeholder="admin@fullerpub.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="password" required
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                            <span>üîë –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</span>
                        </button>
                    </form>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="font-size: 14px; color: #666; margin-bottom: 10px;">–¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</h3>
                        <div style="font-size: 12px; color: #666; line-height: 1.6;">
                            <div><strong>–ê–¥–º–∏–Ω:</strong> admin@bar.com / Admin123</div>
                            <div><strong>–ë–∞—Ä–º–µ–Ω—ã (–ë–∞—Ä 1):</strong> barman1@bar.com / Barman123</div>
                            <div><strong>–ë–∞—Ä–º–µ–Ω—ã (–ë–∞—Ä 2):</strong> barman3@bar.com / Barman123</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
            <div id="mainScreen" style="display: none;">
                <!-- –°–¢–ê–¢–£–° -->
                <div class="alert" id="mainAlert"></div>
                
                <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
                <div class="control-panel" id="controlPanel">
                    <button class="btn btn-success" onclick="openAddModal('category')">
                        <span>üìÅ</span> –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                    </button>
                    <button class="btn btn-success" onclick="openAddModal('product')">
                        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
                
                <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
                        <div class="stat-value" id="statProducts">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                        <div class="stat-value" id="statCategories">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ë–∞—Ä 1 –æ—Å—Ç–∞—Ç–æ–∫</div>
                        <div class="stat-value" id="statBar1">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ë–∞—Ä 2 –æ—Å—Ç–∞—Ç–æ–∫</div>
                        <div class="stat-value" id="statBar2">0</div>
                    </div>
                </div>
                
                <!-- –ü–û–ò–°–ö -->
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                </div>
                
                <!-- –ó–ê–ì–†–£–ó–ö–ê -->
                <div class="loader" id="dataLoader">
                    <div class="loader-spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
                
                <!-- –¢–ê–ë–õ–ò–¶–ê -->
                <div class="table-responsive" id="tableContainer">
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th style="width: 40%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th style="width: 15%;">–û–±—ä–µ–º, –º–ª</th>
                                <th style="width: 20%;">–ë–∞—Ä 1 (—Ñ–∞–∫—Ç)</th>
                                <th style="width: 20%;">–ë–∞—Ä 2 (—Ñ–∞–∫—Ç)</th>
                                <th style="width: 5%;" id="actionsHeader"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="addModalTitle">–î–æ–±–∞–≤–∏—Ç—å</div>
                <button class="close-modal" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body" id="addModalBody">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ò–ù–§–û–†–ú–ê–¶–ò–ò -->
    <div class="modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="infoModalTitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <button class="close-modal" onclick="closeInfoModal()">√ó</button>
            </div>
            <div class="modal-body" id="infoModalBody">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeInfoModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
// –ü—Ä—è–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏)
const SUPABASE_URL = 'https://lmysveosqckpbyuldiym.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxteXN2ZW9zcWNrcGJ5dWxkaXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTMxNTksImV4cCI6MjA4MDM4OTE1OX0.z1i_Fi7uCXnX3cml7RbTHR6RxIrxVY947iOCTi80fQY';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
        
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = null;
        let userRole = null;
        let userBar = 1;
        let products = [];
        let categories = [];
        
        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function initApp() {
            showLoader(true, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session && session.user) {
                await loadUserProfile(session.user.id);
                showMainInterface();
            } else {
                showLoginScreen();
            }
            
            showLoader(false);
        }
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–Ø ====================
async function loadUserProfile(userId) {
    console.log('üîç –ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è:', userId);
    
    try {
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        const { data: profile, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('id', userId)
            .single();
        
        if (error) {
            console.log('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π...', error.message);
            
            // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            const newProfile = await createUserProfile(userId, user.email);
            
            if (!newProfile) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            currentUser = newProfile;
            userRole = 'barman'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞—Ä–º–µ–Ω
            userBar = 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞—Ä 1
            
            console.log('‚úÖ –°–æ–∑–¥–∞–Ω –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            
        } else {
            // –ü—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω
            currentUser = profile;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å
            if (profile.role_id === 1) {
                userRole = 'admin';
            } else {
                userRole = 'barman';
            }
            
            userBar = profile.bar_number || 1;
            
            console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', {
                email: profile.email,
                role: userRole,
                bar: userBar
            });
        }
        
        updateUserUI();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
        
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        try {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = {
                    id: userId,
                    email: user.email,
                    full_name: user.email.split('@')[0]
                };
                userRole = 'barman';
                userBar = 1;
                updateUserUI();
            }
        } catch (e) {
            console.error('–†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', e);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏.', 'error');
            await logout();
        }
    }
}

// ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –°–û–ó–î–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø ====================
async function createUserProfile(userId, userEmail) {
    console.log('üìù –°–æ–∑–¥–∞—é –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è:', userEmail);
    
    try {
        // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ API
        const { data, error } = await supabase
            .from('user_profiles')
            .insert([{
                id: userId,
                email: userEmail,
                full_name: userEmail.split('@')[0],
                role_id: 2, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–∞—Ä–º–µ–Ω
                bar_number: 1
            }])
            .select()
            .single();
        
        if (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ RLS, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
            if (error.code === '42501') {
                console.log('–ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥...');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–æ—Ñ–∏–ª—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
                return {
                    id: userId,
                    email: userEmail,
                    full_name: userEmail.split('@')[0],
                    role_id: 2,
                    bar_number: 1
                };
            }
            return null;
        }
        
        console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω –≤ –ë–î');
        return data;
        
    } catch (error) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
        return null;
    }
}
        // ==================== –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ê ====================
async function checkDatabaseAccess() {
    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ...');
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É categories
        const { data: cats, error: catError } = await supabase
            .from('categories')
            .select('count')
            .limit(1);
        
        if (catError) {
            console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ categories:', catError.message);
        } else {
            console.log('‚úÖ –î–æ—Å—Ç—É–ø –∫ categories –µ—Å—Ç—å');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É user_profiles
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
            const { error: profileError } = await supabase
                .from('user_profiles')
                .select('id')
                .eq('id', user.id)
                .maybeSingle();
            
            if (profileError && profileError.code === '42501') {
                console.error('‚ùå –û–®–ò–ë–ö–ê RLS! –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase');
                showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.', 'error');
            }
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', error);
    }
}
       // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const btn = document.getElementById('loginBtn');
    const alert = document.getElementById('loginAlert');
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ –í—Ö–æ–¥...';
    
    console.log('üîê –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞:', email);
    
    try {
        // 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            // –ü—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –µ—Å–ª–∏ –æ–±—ã—á–Ω—ã–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            if (error.message.includes('Invalid login credentials')) {
                console.log('–ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–æ–ª–∏...');
                
                // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏
                const testPasswords = ['Test123', 'test123', 'Password123', 'password123'];
                
                for (const testPass of testPasswords) {
                    try {
                        const { data: testData, error: testError } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: testPass
                        });
                        
                        if (!testError) {
                            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø–∞—Ä–æ–ª—å: ${testPass}`);
                            data = testData;
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                if (!data) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: Test123');
                }
            } else {
                throw error;
            }
        }
        
        console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (—Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π)
        await loadUserProfile(data.user.id);
        
        // 3. –ü–æ–∫–∞–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        showMainInterface();
        
        showAlert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser?.email || email}!`, 'success', alert);
        
    } catch (error) {
        let errorMessage = error.message;
        
        if (errorMessage.includes('Invalid login credentials')) {
            errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: Test123';
        }
        
        showAlert(`‚ùå ${errorMessage}`, 'error', alert);
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîë –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
    }
});
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            userRole = null;
            showLoginScreen();
        }
        
        // ==================== –ò–ù–¢–ï–†–§–ï–ô–° ====================
        
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }
        
        function showMainInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('appHeader').style.display = 'flex';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
            if (userRole === 'admin') {
                document.getElementById('controlPanel').style.display = 'flex';
                document.getElementById('actionsHeader').innerHTML = '–î–µ–π—Å—Ç–≤–∏—è';
            } else {
                document.getElementById('controlPanel').style.display = 'none';
                document.getElementById('actionsHeader').innerHTML = '';
            }
            
            loadData();
            setupSearch();
        }
        
        function updateUserUI() {
            const name = currentUser.full_name || currentUser.email.split('@')[0];
            const avatarLetter = name.charAt(0).toUpperCase();
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userRole').textContent = 
                userRole === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : `–ë–∞—Ä–º–µ–Ω (–ë–∞—Ä ${userBar})`;
            document.getElementById('userAvatar').textContent = avatarLetter;
        }
        
        function showAlert(message, type, element = null) {
            const alertEl = element || document.getElementById('mainAlert');
            alertEl.className = `alert alert-${type}`;
            alertEl.innerHTML = message;
            alertEl.style.display = 'block';
            
            if (!element) {
                setTimeout(() => {
                    alertEl.style.display = 'none';
                }, 5000);
            }
        }
        
        function showLoader(show, message = '') {
            const loader = document.getElementById('dataLoader');
            if (show) {
                loader.style.display = 'block';
                if (message) {
                    loader.querySelector('div:last-child').textContent = message;
                }
            } else {
                loader.style.display = 'none';
            }
        }
        
        // ==================== –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò ====================
        
        async function loadData() {
            showLoader(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const { data: cats, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('order_index');
                
                if (catError) throw catError;
                categories = cats;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
                const { data: prods, error: prodError } = await supabase
                    .from('products')
                    .select('*')
                    .order('category_id')
                    .order('name');
                
                if (prodError) throw prodError;
                products = prods;
                
                updateTable();
                updateStats();
                
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.category_id]) grouped[p.category_id] = [];
                grouped[p.category_id].push(p);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const sortedCats = [...categories].sort((a, b) => a.order_index - b.order_index);
            
            sortedCats.forEach(category => {
                const catProducts = grouped[category.id] || [];
                
                if (catProducts.length > 0) {
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const catRow = document.createElement('tr');
                    catRow.className = 'category-row';
                    catRow.innerHTML = `<td colspan="5">${category.name}</td>`;
                    tbody.appendChild(catRow);
                    
                    // –ü—Ä–æ–¥—É–∫—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    catProducts.forEach(product => {
                        const row = document.createElement('tr');
                        const canEditBar1 = userRole === 'admin' || (userRole === 'barman' && userBar === 1);
                        const canEditBar2 = userRole === 'admin' || (userRole === 'barman' && userBar === 2);
                        
                        row.innerHTML = `
                            <td>
                                <strong>${product.name}</strong>
                                ${userRole === 'admin' ? 
                                    `<button class="btn btn-sm btn-danger" 
                                             style="margin-left: 10px; padding: 2px 8px; font-size: 12px;"
                                             onclick="deleteProduct(${product.id})">
                                        üóëÔ∏è
                                     </button>` : ''}
                            </td>
                            <td>${product.volume}</td>
                            <td>
                                <input type="number" step="0.1" 
                                       class="stock-input" 
                                       value="${product.bar1 || 0}"
                                       ${canEditBar1 ? '' : 'disabled'}
                                       onchange="updateStock(${product.id}, 'bar1', this.value)"
                                       style="${canEditBar1 ? 'border-color: #28a745;' : ''}">
                            </td>
                            <td>
                                <input type="number" step="0.1"
                                       class="stock-input"
                                       value="${product.bar2 || 0}"
                                       ${canEditBar2 ? '' : 'disabled'}
                                       onchange="updateStock(${product.id}, 'bar2', this.value)"
                                       style="${canEditBar2 ? 'border-color: #28a745;' : ''}">
                            </td>
                            <td>
                                ${userRole === 'admin' ? 
                                    `<button class="btn btn-sm" 
                                             style="padding: 2px 8px;"
                                             onclick="editProduct(${product.id})">
                                        ‚úèÔ∏è
                                     </button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            if (tbody.innerHTML === '') {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                            üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
                        </td>
                    </tr>
                `;
            }
        }
        
        function updateStats() {
            document.getElementById('statProducts').textContent = products.length;
            document.getElementById('statCategories').textContent = categories.length;
            
            const totalBar1 = products.reduce((sum, p) => sum + (parseFloat(p.bar1) || 0), 0);
            const totalBar2 = products.reduce((sum, p) => sum + (parseFloat(p.bar2) || 0), 0);
            
            document.getElementById('statBar1').textContent = totalBar1.toFixed(1);
            document.getElementById('statBar2').textContent = totalBar2.toFixed(1);
        }
        
        async function updateStock(productId, field, value) {
            const numericValue = parseFloat(value) || 0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –±–∞—Ä–º–µ–Ω–æ–≤
            if (userRole === 'barman') {
                if (userBar === 1 && field !== 'bar1') {
                    showAlert('‚ùå –í—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ë–∞—Ä–∞ 1', 'error');
                    loadData(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    return;
                }
                if (userBar === 2 && field !== 'bar2') {
                    showAlert('‚ùå –í—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ë–∞—Ä–∞ 2', 'error');
                    loadData();
                    return;
                }
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .update({ 
                        [field]: numericValue,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', productId);
                
                if (error) throw error;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                const product = products.find(p => p.id === productId);
                if (product) {
                    product[field] = numericValue;
                }
                
                updateStats();
                showAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
                loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            }
        }
        
        // ==================== –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ò ====================
        
        function openAddModal(type) {
            if (userRole !== 'admin') return;
            
            const modal = document.getElementById('addModal');
            const title = document.getElementById('addModalTitle');
            const body = document.getElementById('addModalBody');
            
            if (type === 'category') {
                title.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                body.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                        <input type="text" class="form-control" id="categoryName" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏—Å–∫–∏, –í–æ–¥–∫–∞, –í–∏–Ω–æ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                        <input type="number" class="form-control" id="categoryOrder" value="0">
                        <small style="color: #666; font-size: 12px;">–ß–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ</small>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
            } else {
                title.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
                
                let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                categories.forEach(cat => {
                    options += `<option value="${cat.id}">${cat.name}</option>`;
                });
                
                body.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-control" id="productCategory">
                            ${options}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                        <input type="text" class="form-control" id="productName" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Jack Daniels, Absolut">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–±—ä–µ–º (–º–ª)</label>
                        <input type="number" class="form-control" id="productVolume" 
                               placeholder="500, 700, 1000">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }
        
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        async function addCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const order = document.getElementById('categoryOrder').value || 0;
            
            if (!name) {
                showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .insert([{
                        name: name,
                        order_index: parseInt(order)
                    }]);
                
                if (error) throw error;
                
                showAlert(`‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
                closeAddModal();
                loadData();
                
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function addProduct() {
            const categoryId = document.getElementById('productCategory').value;
            const name = document.getElementById('productName').value.trim();
            const volume = document.getElementById('productVolume').value;
            
            if (!categoryId || !name || !volume) {
                showAlert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (volume <= 0) {
                showAlert('‚ùå –û–±—ä–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('products')
                    .insert([{
                        category_id: parseInt(categoryId),
                        name: name,
                        volume: parseInt(volume),
                        bar1: 0,
                        bar2: 0
                    }]);
                
                if (error) throw error;
                
                showAlert(`‚úÖ –ü—Ä–æ–¥—É–∫—Ç "${name}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
                closeAddModal();
                loadData();
                
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç?')) return;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                showAlert('‚úÖ –ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω', 'success');
                loadData();
                
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            showInfoModal(
                '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞',
                `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ "${product.name}" –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏.`
            );
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        
        function refreshData() {
            loadData();
            showAlert('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#tableBody tr');
                
                let visibleCount = 0;
                
                rows.forEach(row => {
                    if (row.classList.contains('category-row')) {
                        // –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –Ω–µ–π
                        const nextRows = [];
                        let nextRow = row.nextElementSibling;
                        while (nextRow && !nextRow.classList.contains('category-row')) {
                            nextRows.push(nextRow);
                            nextRow = nextRow.nextElementSibling;
                        }
                        
                        const hasVisibleProducts = nextRows.some(r => 
                            r.textContent.toLowerCase().includes(searchTerm)
                        );
                        
                        row.style.display = searchTerm === '' || hasVisibleProducts ? '' : 'none';
                        
                    } else {
                        // –î–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                        const isVisible = searchTerm === '' || 
                                         row.textContent.toLowerCase().includes(searchTerm);
                        row.style.display = isVisible ? '' : 'none';
                        if (isVisible) visibleCount++;
                    }
                });
            });
        }
        
        async function exportData() {
            let csv = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–û–±—ä–µ–º,–º–ª;–ë–∞—Ä 1;–ë–∞—Ä 2\n';
            
            products.forEach(product => {
                const category = categories.find(c => c.id === product.category_id);
                csv += `"${category?.name || ''}";"${product.name}";${product.volume};${product.bar1 || 0};${product.bar2 || 0}\n`;
            });
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `fullerpub_stock_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('‚úÖ –§–∞–π–ª CSV —Å–∫–∞—á–∞–Ω', 'success');
        }
        
        function showInfoModal(title, content) {
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalBody').innerHTML = content;
            document.getElementById('infoModal').style.display = 'flex';
        }
        
        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            setInterval(() => {
                if (currentUser) loadData();
            }, 300000);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentUser) {
                    loadData();
                }
            });
        });
    </script>
</body>
</html>
